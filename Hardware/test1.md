ПРОТОКОЛ ПЕРЕДАЧИ ДАННЫХ  
УСТРОЙСТВА TIMEFLIP  
  
версия 3.1  
06.04.2018

2018

Все значения в TimeFlip хранятся в оперативной памяти и при отключении батарейки скидываются на значение по умолчанию.

Устройство TimeFlip работает по протоколу Bluetooth Low Energy (BLE) с сервисами и характеристиками указанными в таблице 1.  
  
Таблица 1 - Сервисы и характеристики устройства TimeFlip:

<table>
<thead>
<tr class="header">
<th>№</th>
<th>Имя сервиса/UUID</th>
<th>Имя характеристики/UUID</th>
<th>Размер, байт</th>
<th><p>Свойства</p>
<p>R – чтение</p>
<p>W – запись</p>
<p>N – нотификация</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><p>Device Information /</p>
<p>0x180A</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><p>Firmware Revision String /</p>
<p>0x2A26</p></td>
<td>6</td>
<td>R</td>
</tr>
<tr class="odd">
<td>2</td>
<td><p>Battery Service /</p>
<p>0x180F</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><p>Battery Level /</p>
<p>0x2A19</p></td>
<td>1</td>
<td>R, N</td>
</tr>
<tr class="odd">
<td>3</td>
<td>TimeFlip /<br />
F1196F50-71A4-11E6-BDF4-0800200C9A66</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>Данные акселерометра /<br />
F1196F51-71A4-11E6-BDF4-0800200C9A66</td>
<td>6</td>
<td>R</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td><p>Стороны /</p>
<p>F1196F52-71A4-11E6-BDF4-0800200C9A66</p></td>
<td>1</td>
<td>R, N</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><p>Вывод результата команды /</p>
<p>F1196F53-71A4-11E6-BDF4-0800200C9A66</p></td>
<td>21</td>
<td>R</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td><p>Команда /</p>
<p>F1196F54-71A4-11E6-BDF4-0800200C9A66</p></td>
<td>21</td>
<td>R, W</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><p>Определение двойного тап /</p>
<p>F1196F55-71A4-11E6-BDF4-0800200C9A66</p></td>
<td>1</td>
<td>N</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>Версия калибровки /<br />
F1196F56-71A4-11E6-BDF4-0800200C9A66</td>
<td>4</td>
<td>R, W</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><p>Пароль /</p>
<p>F1196F57-71A4-11E6-BDF4-0800200C9A66</p></td>
<td>6</td>
<td>W</td>
</tr>
</tbody>
</table>

**Firmware Revision String**

UUID:

0x2A26

<table>
<thead>
<tr class="header">
<th>Тип</th>
<th>Доступ</th>
<th>Размер, байт</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Версия прошивки</td>
<td>Чтение</td>
<td>6</td>
<td><p>Содержит версию прошивки в строковом виде.</p>
<p>0x544676332E31 = “TFv3.1”</p></td>
</tr>
</tbody>
</table>

**Battery Level **

UUID:

0x2A19

<table>
<thead>
<tr class="header">
<th>Тип</th>
<th>Доступ</th>
<th>Размер, байт</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Заряд батареи</td>
<td><p>Чтение,</p>
<p>Нотификация</p></td>
<td>1</td>
<td>Заряд батареи в процентах</td>
</tr>
</tbody>
</table>

**Характеристика данных акселерометра**

**  
**UUID:  
F1196F51-71A4-11E6-BDF4-0800200C9A66

<table>
<thead>
<tr class="header">
<th>Тип</th>
<th>Доступ</th>
<th>Размер, байт</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Данные с акселерометра</td>
<td>Чтение</td>
<td>6</td>
<td><p><em>big-endian</em></p>
<p>1,2 байт – значение акселерометра X</p>
<p>3,4 байт – значение акселерометра Y</p>
<p>5,6 байт – значение акселерометра Z</p></td>
</tr>
</tbody>
</table>

**Характеристика стороны  
**  
UUID:  
F1196F52-71A4-11E6-BDF4-0800200C9A66

<table>
<thead>
<tr class="header">
<th>Тип</th>
<th>Доступ</th>
<th>Размер, байт</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Данные стороны</td>
<td><p>Чтение,</p>
<p>Нотификация</p></td>
<td>1</td>
<td>Значение ID нотифицируемой стороны (0..47)</td>
</tr>
</tbody>
</table>

**Характеристика вывод результата команды**

UUID:

F1196F53-71A4-11E6-BDF4-0800200C9A66

<table>
<thead>
<tr class="header">
<th>Тип</th>
<th>Доступ</th>
<th>Размер, байт</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Вывод команд</td>
<td>Чтение</td>
<td>21</td>
<td><p>Вывод результата выполнение команд:</p>
<p>0x01 - запрос на чтении истории</p>
<p>0x10 - запрос статуса</p></td>
</tr>
</tbody>
</table>

История считывается пакетами по 21 байт.

Блок истории состоит из 3 байт

| Номер БАЙТА | 0   | 1   | 2   |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |
|-------------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| Номер БИТА  | 0   | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   | 10  | 11  | 12  | 13  | 14  | 15  | 16  | 17  | 18  | 19  | 20  | 21  | 22  | 23  |
| время       | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   | x   |     |     |     |     |     |     |
| сторона     |     | x   | x   | x   | x   | x   | x   |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |

Максимальное хранимое время, в секундах – 262144 сек. \~ 3,03 суток.

Максимальный номер стороны – 48

В одном пакете умещается 7 блоков истории.

<span class="underline">Протокол чтения истории</span>

После отправки команды запроса истории в характеристику будет записан первый пакет историй из 7 блоков, блоки истории будут обновляться по мере чтения истории до самого последнего. Пример

| Номер БАЙТА  | 0   | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   | 10  | 11  | 12  | 13  | 14  | 15  | 16  | 17  | 18  | 19  | 20  |
|--------------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| Блок истории | 0   | 1   | 2   | 3   | 4   | 5   | 6   |     |     |     |     |     |     |     |     |     |     |     |     |     |     |

Если последний пакет истории не будет заполнен полностью, то недостающие значения будут заполнены нулями.

Предпоследним пакет будет содержать информацию о количестве отправленных блоков истории. Пример

<table>
<thead>
<tr class="header">
<th>Номер БАЙТА</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
<th>13</th>
<th>14</th>
<th>15</th>
<th>16</th>
<th>17</th>
<th>18</th>
<th>19</th>
<th>20</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Количество</p>
<p>блоков</p></td>
<td>Х</td>
<td>Х</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

Последний пакет состоит из нулей, данный пакет сообщает о конце передачи истории.

Пример

<table>
<thead>
<tr class="header">
<th>Номер БАЙТА</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
<th>13</th>
<th>14</th>
<th>15</th>
<th>16</th>
<th>17</th>
<th>18</th>
<th>19</th>
<th>20</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Количество</p>
<p>блоков</p></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

**Характеристика команды**

UUID:

F1196F54-71A4-11E6-BDF4-0800200C9A66

При успешном выполнение команды из характеристики можно прочитать 0xXX 0x02 где 0хХХ переданная команда.

При неверном выполнение команды из характеристики можно прочитать 0xXX 0x01 где 0хХХ переданная команда.

<table>
<thead>
<tr class="header">
<th>Тип</th>
<th>Доступ</th>
<th>Размер, байт</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Команда</td>
<td>Запись</td>
<td>21</td>
<td><p>0x01 - запрос на чтении истории (ответ читаем из “<strong>вывод результата команды</strong>”)<br />
0x02 - удалить историю</p>
<p>0x03 - удалить калибровку</p>
<p>Удаляет сохраненные стороны TimeFlip и сбрасывает значения характеристики <em>Версия калибровки</em> (UUID: F1196F56-71A4-11E6-BDF4-0800200C9A66) в ноль.</p>
<p>0x04 0x01 – блокировка<sup>*</sup> включена</p>
<p>0x04 0x02 – блокировка выключена</p>
<p>0x05 0xXX 0xXX - автопауза<sup>**</sup> (по умолчанию выключена)<br />
0xXX 0xXX – время таймера в минутах, через которое произойдет пауза (0 – выключена автопауза)<br />
Сброс таймера автопаузы происходит при смене стороны и отсчитывается заново.<br />
<br />
0x06 0x01 - пауза<sup>***</sup> включена<br />
0x06 0x02 - пауза выключена<br />
<br />
0x10 - запрос статуса (ответ читаем из “<strong>вывод результата команды</strong>” вида 0xXX  0xYY  0xZZ 0xZZ)<br />
0xXX - блокировка (0x01 – включена, 0x02 – выключена)<br />
0xYY - пауза (0x01 – включена, 0x02 – выключена)<br />
0xZZ 0xZZ - значение таймера автопаузы (в минутах)<br />
<br />
0x15 0xXX 0xZZ … 0xZZ - запись имени<br />
0xXX - количество символов в имени<br />
0xZZ … 0xZZ - имя (19 символов макс. кодировка ASCII)</p>
<p>0х30 0xZZ … 0xZZ – задать новый пароль</p>
<p>0xZZ … 0xZZ – задаваемый пароль, длина пароля 6 символов</p>
<p>0x50 0xAA – Стереть текущею прошивку и перейти в загрузчик прошивок.</p></td>
</tr>
<tr class="even">
<td></td>
<td>Чтение</td>
<td>2</td>
<td><p>0xXX, 0xYY</p>
<p>0xXX - номер команды</p>
<p>0xYY - код ошибки (2 - OK, 1 - ERROR)</p></td>
</tr>
</tbody>
</table>

^\*^ блокировка (lock) – идет время на последней стороне и перестает реагировать на изменение сторон (стороны не нотифицируются)

^\*\*^ автопауза (autopause) – после срабатывания таймера устанавливается пауза  
^\*\*\*^ пауза (pause) – в историю будет добавлен интервал на стороне с ID 63 (0b111111), стороны продолжают нотифицироваться (в нотификации будет отправлен ID стороны на которую поставили)

**Характеристика определения двойного тапа**

UUID:

F1196F55-71A4-11E6-BDF4-0800200C9A66

!!!! Данная характеристика не работает. !!!!

**Версия калибровки**

UUID:

F1196F56-71A4-11E6-BDF4-0800200C9A66

| Тип | Доступ         | Размер, байт | Описание                                                                                                                                                 |
|-----|----------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|
|     | Запись, Чтение | 4            | Сохраняет записанное значение между коннектами. Значение сбрасывается в 0 при отключение батарейки и при выполнение команды “удалить калибровку (0x03)”. |

Данная характеристика используется для того чтобы определить совпадает ли калибровка сторон TimeFlip с калибровками в приложении. Проверка происходит в виде сравнения числа прочитанного из данной характеристики с числом сохраненном в приложении. При задание сторон TimeFlip в приложении в данную характеристику записывает произвольное число, это же число сохраняться в приложении.

**Пароль **

UUID:

F1196F57-71A4-11E6-BDF4-0800200C9A66

| Тип    | Доступ | Размер, байт | Описание                                                                                                                                                                                               |
|--------|--------|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Пароль | Запись | 6            | Характеристика в которую необходимо записать значение пароля для того чтобы TimeFlip начал выполнять команды. Сбрасывается после отключения от кубика от телефона. Требуется вводит после подключения. |

Если не ввести или ввести неверный пароль то в кастомных характеристиках TimeFlip будет возвращать нули при чтении, при записи в характеристику изменений не будет происходить.
