
# ПРОТОКОЛ ПЕРЕДАЧИ ДАННЫХ  

Все значения в TimeFlip хранятся в оперативной памяти и при отключении батарейки скидываются на значение по умолчанию.

Устройство TimeFlip работает по протоколу Bluetooth Low Energy (BLE) с сервисами и характеристиками указанными в таблице:

| Имя сервиса / UUID            | Описание                             |
|:----------------------------|:-------------------------------------|
|Device Information / 0x180A  | Содержит информацию об устройстве    |
|Battery Service / 0x180F     | Заряд батареи                        |
|TimeFlip / F1196F50-71A4-11E6-BDF4-0800200C9A66 | Временя и стороны |

#### Device Information Service / 0x180A
| Имя характеристики | Размер, байт | Свойства, R/W/N |
| :----------------- |:------------:|:---------------:|
| Firmware Revision String / 0x2A26| 6 | R |
R – чтение W – запись N – нотификация

#### Battery Service / 0x180F
| Имя характеристики | Размер, байт | Свойства, R/W/N |
| :----------------- |:------------:|:---------------:|
| Battery Level / 0x2A19| 1 | R,N |
R – чтение W – запись N – нотификация

#### TimeFlip Service /  F1196F50-71A4-11E6-BDF4-0800200C9A66
| Имя характеристики | Размер, байт | Свойства, R/W/N |
| :----------------- |:------------:|:---------------:|
| Данные акселерометра / F1196F51-71A4-11E6-BDF4-0800200C9A66 | 6 | R |
| Стороны / F1196F52-71A4-11E6-BDF4-0800200C9A66 | 1 | R, N |
| Вывод результата команды / F1196F53-71A4-11E6-BDF4-0800200C9A66 | 21 | R |
| Команда / F1196F54-71A4-11E6-BDF4-0800200C9A66 | 21 | R, W |
| Определение двойного тап / F1196F55-71A4-11E6-BDF4-0800200C9A66 | 1 | N |
| Версия калибровки / F1196F56-71A4-11E6-BDF4-0800200C9A66 | 4 | R, W |
| Пароль / F1196F57-71A4-11E6-BDF4-0800200C9A66 | 6 | W |
R – чтение W – запись N – нотификация

### Firmware Revision String / 0x2A26
Содержит версию прошивки в строковом виде.
0x544676332E31 = “TFv3.1”

### Battery Level  / 0x2A19
Заряд батареи в процентах

### Характеристика данных акселерометра / F1196F51-71A4-11E6-BDF4-0800200C9A66
_big-endian_ 0xXXYYZZ  - (x,y,z) текущий вектор ускорения.

### Характеристика стороны  / F1196F52-71A4-11E6-BDF4-0800200C9A66
Значение ID нотифицируемой стороны (0..47)

### Характеристика вывод результата команды / F1196F53-71A4-11E6-BDF4-0800200C9A66
Вывод результата выполнение команд:
0x01 - запрос на чтении истории
0x10 - запрос статуса

История считывается пакетами по 21 байт.
Блок истории состоит из 3 байт. Пример:

| Номер байта | 0 |   |   |   |   |   |   |   | 1 |   |    |    |    |    |    |    |  2 |    |    |    |    |    |    |    |
|:-----------:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|  Номер бита | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 |
|    Время    | X | X | X | X | X | X | X | X | X | X |  X |  X |  X |  X |  X |  X |  X |  X |    |    |    |    |    |    |
|   Сторона   |   |   |   |   |   |   |   |   |   |   |    |    |    |    |    |    |    |    |  X |  X |  X |  X |  X |  X |

Максимальное хранимое время, в секундах – 262144 сек. \~ 3,03 суток.
Максимальный номер стороны – 48
В одном пакете умещается 7 блоков истории.

#### Протокол чтения истории
После отправки команды запроса истории в характеристику будет записан первый пакет историй из 7 блоков, блоки истории будут обновляться по мере чтения истории до самого последнего. Пример:

| Номер БАЙТА  | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 |
|--------------|---|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| блок истории | 0 | 0 | 0 | 1 | 1 | 1 | 2 | 2 | 2 | 3 |  3 |  3 |  4 |  4 |  4 |  5 |  5 |  5 |  6 |  6 |  6 |

Если последний пакет истории не будет заполнен полностью, то недостающие значения будут заполнены нулями.
Предпоследним пакет будет содержать информацию о количестве отправленных блоков истории. Пример:

| Номер БАЙТА  | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 |
|:--------------:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| Блок истории | X | X | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 | 0 |

Последний пакет состоит из нулей, данный пакет сообщает о конце передачи истории. Пример:

| Номер БАЙТА  | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 |
|:--------------:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| Количество блоков | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 |  0 | 0 |

### Характеристика команды / F1196F54-71A4-11E6-BDF4-0800200C9A66

При успешном выполнение команды из характеристики можно прочитать 0xXX 0x02 где 0хХХ переданная команда.
При неверном выполнение команды из характеристики можно прочитать 0xXX 0x01 где 0хХХ переданная команда.

|Тип      | Доступ | Размер, байт | Описание |
|---------|--------|----|----------|
| Команда | Запись | 21 | 0xXXYY..YY, где XX - номер команды, YY - данные. Ответ читаем из “**вывод результата команды**” |
|         | Чтение | 2  | 0xXXYY, где XX - номер команды YY - код ошибки (2 - OK, 1 - ERROR)|

#### Команды: 

0x01 - запрос на чтении истории (ответ читаем из “**вывод результата команды**”)  
0x02 - удалить историю

0x03 - удалить калибровку

Удаляет сохраненные стороны TimeFlip и сбрасывает значения характеристики _Версия калибровки_ (UUID: F1196F56-71A4-11E6-BDF4-0800200C9A66) в ноль.

0x04 0x01 – блокировка* включена

0x04 0x02 – блокировка выключена

0x05 0xXX 0xXX - автопауза** (по умолчанию выключена)  
0xXX 0xXX – время таймера в минутах, через которое произойдет пауза (0 – выключена автопауза)  
Сброс таймера автопаузы происходит при смене стороны и отсчитывается заново.  
  
0x06 0x01 - пауза*** включена  
0x06 0x02 - пауза выключена  
  
0x10 - запрос статуса (ответ читаем из “**вывод результата команды**” вида 0xXX 0xYY 0xZZ 0xZZ)  
0xXX - блокировка (0x01 – включена, 0x02 – выключена)  
0xYY - пауза (0x01 – включена, 0x02 – выключена)  
0xZZ 0xZZ - значение таймера автопаузы (в минутах)  
  
0x15 0xXX 0xZZ … 0xZZ - запись имени  
0xXX - количество символов в имени  
0xZZ … 0xZZ - имя (19 символов макс. кодировка ASCII)

0х30 0xZZ … 0xZZ – задать новый пароль

0xZZ … 0xZZ – задаваемый пароль, длина пароля 6 символов

0x50 0xAA – Стереть текущею прошивку и перейти в загрузчик прошивок.

\* блокировка (lock) – идет время на последней стороне и перестает реагировать на изменение сторон (стороны не нотифицируются)
\*\* автопауза (autopause) – после срабатывания таймера устанавливается пауза  
\*\*\* пауза (pause) – в историю будет добавлен интервал на стороне с ID 63 (0b111111), стороны продолжают нотифицироваться (в нотификации будет отправлен ID стороны на которую поставили)

### Характеристика определения двойного тапа / F1196F55-71A4-11E6-BDF4-0800200C9A66
!!!! Данная характеристика не работает. !!!!

### Характеристика версия калибровки / F1196F56-71A4-11E6-BDF4-0800200C9A66

| Тип | Доступ         | Размер, байт | Описание                                                                                                                                                 |
|-----|----------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|
|     | Запись, Чтение | 4            | Сохраняет записанное значение между коннектами. Значение сбрасывается в 0 при отключение батарейки и при выполнение команды “удалить калибровку (0x03)”. |

Данная характеристика используется для того чтобы определить совпадает ли калибровка сторон TimeFlip с калибровками в приложении. Проверка происходит в виде сравнения числа прочитанного из данной характеристики с числом сохраненном в приложении. При задание сторон TimeFlip в приложении в данную характеристику записывает произвольное число, это же число сохраняться в приложении.

### Характеристика пароль / F1196F57-71A4-11E6-BDF4-0800200C9A66

| Тип    | Доступ | Размер, байт | Описание                                                                                                                                                                                               |
|--------|--------|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Пароль | Запись | 6            | Характеристика в которую необходимо записать значение пароля для того чтобы TimeFlip начал выполнять команды. Сбрасывается после отключения кубика от телефона. Требуется вводит после подключения. |

Если не ввести или ввести неверный пароль то в кастомных характеристиках TimeFlip будет возвращать нули при чтении, при записи в характеристику изменений не будет происходить.
