ПРОТОКОЛ ПЕРЕДАЧИ ДАННЫХ\
УСТРОЙСТВА TIMEFLIP\
\
версия 3.1\
06.04.2018

2018

Все значения в TimeFlip хранятся в оперативной памяти и при отключении
батарейки скидываются на значение по умолчанию.

Устройство TimeFlip работает по протоколу Bluetooth Low Energy (BLE) с
сервисами и характеристиками указанными в таблице 1.\
\
Таблица 1 - Сервисы и характеристики устройства TimeFlip:

+-------------+-------------+-------------+-------------+-------------+
| №           | Имя         | Имя         | Размер,     | Свойства    |
|             | сервиса/UUI | характерист | байт        |             |
|             | D           | ики/UUID    |             | R -- чтение |
|             |             |             |             |             |
|             |             |             |             | W -- запись |
|             |             |             |             |             |
|             |             |             |             | N --        |
|             |             |             |             | нотификация |
+=============+=============+=============+=============+=============+
| 1           | Device      |             |             |             |
|             | Information |             |             |             |
|             | /           |             |             |             |
|             |             |             |             |             |
|             | 0x180A      |             |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Firmware    | 6           | R           |
|             |             | Revision    |             |             |
|             |             | String /    |             |             |
|             |             |             |             |             |
|             |             | 0x2A26      |             |             |
+-------------+-------------+-------------+-------------+-------------+
| 2           | Battery     |             |             |             |
|             | Service /   |             |             |             |
|             |             |             |             |             |
|             | 0x180F      |             |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Battery     | 1           | R, N        |
|             |             | Level /     |             |             |
|             |             |             |             |             |
|             |             | 0x2A19      |             |             |
+-------------+-------------+-------------+-------------+-------------+
| 3           | TimeFlip /\ |             | 1           |             |
|             | F1196F50-71 |             |             |             |
|             | A4-11E6-BDF |             |             |             |
|             | 4-0800200C9 |             |             |             |
|             | A66         |             |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Данные      | 6           | R           |
|             |             | акселеромет |             |             |
|             |             | ра          |             |             |
|             |             | /\          |             |             |
|             |             | F1196F51-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Стороны /   | 1           | R, N        |
|             |             |             |             |             |
|             |             | F1196F52-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Вывод       | 21          | R           |
|             |             | результата  |             |             |
|             |             | команды /   |             |             |
|             |             |             |             |             |
|             |             | F1196F53-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Команда /   | 21          | R, W        |
|             |             |             |             |             |
|             |             | F1196F54-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Определение | 1           | N           |
|             |             | двойного    |             |             |
|             |             | тап /       |             |             |
|             |             |             |             |             |
|             |             | F1196F55-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Версия      | 4           | R, W        |
|             |             | калибровки  |             |             |
|             |             | /\          |             |             |
|             |             | F1196F56-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+
|             |             | Пароль /    | 6           | W           |
|             |             |             |             |             |
|             |             | F1196F57-71 |             |             |
|             |             | A4-11E6-BDF |             |             |
|             |             | 4-0800200C9 |             |             |
|             |             | A66         |             |             |
+-------------+-------------+-------------+-------------+-------------+

**Firmware Revision String**

UUID:

0x2A26

+-----------------+-----------------+-----------------+-----------------+
| Тип             | Доступ          | Размер, байт    | Описание        |
+=================+=================+=================+=================+
| Версия прошивки | Чтение          | 6               | Содержит версию |
|                 |                 |                 | прошивки в      |
|                 |                 |                 | строковом виде. |
|                 |                 |                 |                 |
|                 |                 |                 | 0x544676332E31  |
|                 |                 |                 | = "TFv3.1"      |
+-----------------+-----------------+-----------------+-----------------+

**Battery Level **

UUID:

0x2A19

+---------------+-------------+--------------+---------------------------+
| Тип           | Доступ      | Размер, байт | Описание                  |
+===============+=============+==============+===========================+
| Заряд батареи | Чтение,     | 1            | Заряд батареи в процентах |
|               |             |              |                           |
|               | Нотификация |              |                           |
+---------------+-------------+--------------+---------------------------+

**Характеристика данных акселерометра**

**\
**UUID:\
F1196F51-71A4-11E6-BDF4-0800200C9A66

+-----------------+-----------------+-----------------+-----------------+
| Тип             | Доступ          | Размер, байт    | Описание        |
+=================+=================+=================+=================+
| Данные с        | Чтение          | 6               | *big-endian*    |
| акселерометра   |                 |                 |                 |
|                 |                 |                 | 1,2 байт --     |
|                 |                 |                 | значение        |
|                 |                 |                 | акселерометра X |
|                 |                 |                 |                 |
|                 |                 |                 | 3,4 байт --     |
|                 |                 |                 | значение        |
|                 |                 |                 | акселерометра Y |
|                 |                 |                 |                 |
|                 |                 |                 | 5,6 байт --     |
|                 |                 |                 | значение        |
|                 |                 |                 | акселерометра Z |
+-----------------+-----------------+-----------------+-----------------+

**Характеристика стороны\
**\
UUID:\
F1196F52-71A4-11E6-BDF4-0800200C9A66

+-----------------+-----------------+-----------------+-----------------+
| Тип             | Доступ          | Размер, байт    | Описание        |
+=================+=================+=================+=================+
| Данные стороны  | Чтение,         | 1               | Значение ID     |
|                 |                 |                 | нотифицируемой  |
|                 | Нотификация     |                 | стороны (0..47) |
+-----------------+-----------------+-----------------+-----------------+

**Характеристика вывод результата команды**

UUID:

F1196F53-71A4-11E6-BDF4-0800200C9A66

+--------------+--------+--------------+-------------------------------------+
| Тип          | Доступ | Размер, байт | Описание                            |
+==============+========+==============+=====================================+
| Вывод команд | Чтение | 21           | Вывод результата выполнение команд: |
|              |        |              |                                     |
|              |        |              | 0x01 - запрос на чтении истории     |
|              |        |              |                                     |
|              |        |              | 0x10 - запрос статуса               |
+--------------+--------+--------------+-------------------------------------+

История считывается пакетами по 21 байт.

Блок истории состоит из 3 байт

  Номер БАЙТА   0   1   2                                                                                                
  ------------- --- --- --- --- --- --- --- --- --- --- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
  Номер БИТА    0   1   2   3   4   5   6   7   8   9   10   11   12   13   14   15   16   17   18   19   20   21   22   23
  время         x   x   x   x   x   x   x   x   x   x   x    x    x    x    x    x    x    x                             
  сторона           x   x   x   x   x   x                                                                                

Максимальное хранимое время, в секундах -- 262144 сек. \~ 3,03 суток.

Максимальный номер стороны -- 48

В одном пакете умещается 7 блоков истории.

[Протокол чтения истории]{.underline}

После отправки команды запроса истории в характеристику будет записан
первый пакет историй из 7 блоков, блоки истории будут обновляться по
мере чтения истории до самого последнего. Пример

  Номер БАЙТА    0   1   2   3   4   5   6   7   8   9   10   11   12   13   14   15   16   17   18   19   20
  -------------- --- --- --- --- --- --- --- --- --- --- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
  Блок истории   0   1   2   3   4   5   6                                                                 

Если последний пакет истории не будет заполнен полностью, то недостающие
значения будут заполнены нулями.

Предпоследним пакет будет содержать информацию о количестве отправленных
блоков истории. Пример

<table>
<thead>
<tr class="header">
<th>Номер БАЙТА</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
<th>13</th>
<th>14</th>
<th>15</th>
<th>16</th>
<th>17</th>
<th>18</th>
<th>19</th>
<th>20</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Количество</p>
<p>блоков</p></td>
<td>Х</td>
<td>Х</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

Последний пакет состоит из нулей, данный пакет сообщает о конце передачи
истории.

Пример

<table>
<thead>
<tr class="header">
<th>Номер БАЙТА</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
<th>13</th>
<th>14</th>
<th>15</th>
<th>16</th>
<th>17</th>
<th>18</th>
<th>19</th>
<th>20</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Количество</p>
<p>блоков</p></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

**Характеристика команды**

UUID:

F1196F54-71A4-11E6-BDF4-0800200C9A66

При успешном выполнение команды из характеристики можно прочитать 0xXX
0x02 где 0хХХ переданная команда.

При неверном выполнение команды из характеристики можно прочитать 0xXX
0x01 где 0хХХ переданная команда.

+-----------------+-----------------+-----------------+-----------------+
| Тип             | Доступ          | Размер, байт    | Описание        |
+=================+=================+=================+=================+
| Команда         | Запись          | 21              | 0x01 - запрос   |
|                 |                 |                 | на чтении       |
|                 |                 |                 | истории (ответ  |
|                 |                 |                 | читаем из       |
|                 |                 |                 | "**вывод        |
|                 |                 |                 | результата      |
|                 |                 |                 | команды**")\    |
|                 |                 |                 | 0x02 - удалить  |
|                 |                 |                 | историю         |
|                 |                 |                 |                 |
|                 |                 |                 | 0x03 - удалить  |
|                 |                 |                 | калибровку      |
|                 |                 |                 |                 |
|                 |                 |                 | Удаляет         |
|                 |                 |                 | сохраненные     |
|                 |                 |                 | стороны         |
|                 |                 |                 | TimeFlip и      |
|                 |                 |                 | сбрасывает      |
|                 |                 |                 | значения        |
|                 |                 |                 | характеристики  |
|                 |                 |                 | *Версия         |
|                 |                 |                 | калибровки*     |
|                 |                 |                 | (UUID:          |
|                 |                 |                 | F1196F56-71A4-1 |
|                 |                 |                 | 1E6-BDF4-080020 |
|                 |                 |                 | 0C9A66)         |
|                 |                 |                 | в ноль.         |
|                 |                 |                 |                 |
|                 |                 |                 | 0x04 0x01 --    |
|                 |                 |                 | блокировка^\*^  |
|                 |                 |                 | включена        |
|                 |                 |                 |                 |
|                 |                 |                 | 0x04 0x02 --    |
|                 |                 |                 | блокировка      |
|                 |                 |                 | выключена       |
|                 |                 |                 |                 |
|                 |                 |                 | 0x05 0xXX 0xXX  |
|                 |                 |                 | -               |
|                 |                 |                 | автопауза^\*\*^ |
|                 |                 |                 | (по умолчанию   |
|                 |                 |                 | выключена)\     |
|                 |                 |                 | 0xXX 0xXX --    |
|                 |                 |                 | время таймера в |
|                 |                 |                 | минутах, через  |
|                 |                 |                 | которое         |
|                 |                 |                 | произойдет      |
|                 |                 |                 | пауза (0 --     |
|                 |                 |                 | выключена       |
|                 |                 |                 | автопауза)\     |
|                 |                 |                 | Сброс таймера   |
|                 |                 |                 | автопаузы       |
|                 |                 |                 | происходит при  |
|                 |                 |                 | смене стороны и |
|                 |                 |                 | отсчитывается   |
|                 |                 |                 | заново.\        |
|                 |                 |                 | \               |
|                 |                 |                 | 0x06 0x01 -     |
|                 |                 |                 | пауза^\*\*\*^   |
|                 |                 |                 | включена\       |
|                 |                 |                 | 0x06 0x02 -     |
|                 |                 |                 | пауза           |
|                 |                 |                 | выключена\      |
|                 |                 |                 | \               |
|                 |                 |                 | 0x10 - запрос   |
|                 |                 |                 | статуса (ответ  |
|                 |                 |                 | читаем из       |
|                 |                 |                 | "**вывод        |
|                 |                 |                 | результата      |
|                 |                 |                 | команды**" вида |
|                 |                 |                 | 0xXX  0xYY      |
|                 |                 |                 |  0xZZ 0xZZ)\    |
|                 |                 |                 | 0xXX -          |
|                 |                 |                 | блокировка      |
|                 |                 |                 | (0x01 --        |
|                 |                 |                 | включена, 0x02  |
|                 |                 |                 | -- выключена)\  |
|                 |                 |                 | 0xYY - пауза    |
|                 |                 |                 | (0x01 --        |
|                 |                 |                 | включена, 0x02  |
|                 |                 |                 | -- выключена)\  |
|                 |                 |                 | 0xZZ 0xZZ -     |
|                 |                 |                 | значение        |
|                 |                 |                 | таймера         |
|                 |                 |                 | автопаузы (в    |
|                 |                 |                 | минутах)\       |
|                 |                 |                 | \               |
|                 |                 |                 | 0x15 0xXX 0xZZ  |
|                 |                 |                 | ... 0xZZ -      |
|                 |                 |                 | запись имени\   |
|                 |                 |                 | 0xXX -          |
|                 |                 |                 | количество      |
|                 |                 |                 | символов в      |
|                 |                 |                 | имени\          |
|                 |                 |                 | 0xZZ ... 0xZZ - |
|                 |                 |                 | имя (19         |
|                 |                 |                 | символов макс.  |
|                 |                 |                 | кодировка       |
|                 |                 |                 | ASCII)          |
|                 |                 |                 |                 |
|                 |                 |                 | 0х30 0xZZ ...   |
|                 |                 |                 | 0xZZ -- задать  |
|                 |                 |                 | новый пароль    |
|                 |                 |                 |                 |
|                 |                 |                 | 0xZZ ... 0xZZ   |
|                 |                 |                 | -- задаваемый   |
|                 |                 |                 | пароль, длина   |
|                 |                 |                 | пароля 6        |
|                 |                 |                 | символов        |
|                 |                 |                 |                 |
|                 |                 |                 | 0x50 0xAA --    |
|                 |                 |                 | Стереть текущею |
|                 |                 |                 | прошивку и      |
|                 |                 |                 | перейти в       |
|                 |                 |                 | загрузчик       |
|                 |                 |                 | прошивок.       |
+-----------------+-----------------+-----------------+-----------------+
|                 | Чтение          | 2               | 0xXX, 0xYY      |
|                 |                 |                 |                 |
|                 |                 |                 | 0xXX - номер    |
|                 |                 |                 | команды         |
|                 |                 |                 |                 |
|                 |                 |                 | 0xYY - код      |
|                 |                 |                 | ошибки (2 - OK, |
|                 |                 |                 | 1 - ERROR)      |
+-----------------+-----------------+-----------------+-----------------+

^\*^ блокировка (lock) -- идет время на последней стороне и перестает
реагировать на изменение сторон (стороны не нотифицируются)

^\*\*^ автопауза (autopause) -- после срабатывания таймера
устанавливается пауза\
^\*\*\*^ пауза (pause) -- в историю будет добавлен интервал на стороне с
ID 63 (0b111111), стороны продолжают нотифицироваться (в нотификации
будет отправлен ID стороны на которую поставили)

**Характеристика определения двойного тапа**

UUID:

F1196F55-71A4-11E6-BDF4-0800200C9A66

!!!! Данная характеристика не работает. !!!!

**Версия калибровки**

UUID:

F1196F56-71A4-11E6-BDF4-0800200C9A66

  Тип   Доступ           Размер, байт   Описание
  ----- ---------------- -------------- ----------------------------------------------------------------------------------------------------------------------------------------------------------
        Запись, Чтение   4              Сохраняет записанное значение между коннектами. Значение сбрасывается в 0 при отключение батарейки и при выполнение команды "удалить калибровку (0x03)".

Данная характеристика используется для того чтобы определить совпадает
ли калибровка сторон TimeFlip с калибровками в приложении. Проверка
происходит в виде сравнения числа прочитанного из данной характеристики
с числом сохраненном в приложении. При задание сторон TimeFlip в
приложении в данную характеристику записывает произвольное число, это же
число сохраняться в приложении.

**Пароль **

UUID:

F1196F57-71A4-11E6-BDF4-0800200C9A66

  Тип      Доступ   Размер, байт   Описание
  -------- -------- -------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  Пароль   Запись   6              Характеристика в которую необходимо записать значение пароля для того чтобы TimeFlip начал выполнять команды. Сбрасывается после отключения от кубика от телефона. Требуется вводит после подключения.

Если не ввести или ввести неверный пароль то в кастомных характеристиках
TimeFlip будет возвращать нули при чтении, при записи в характеристику
изменений не будет происходить.
